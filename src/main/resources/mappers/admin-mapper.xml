<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- !namespace : 해당 mapper파일의 고유한 별칭 -->
<mapper namespace="adminMapper">

	<!-- =============================select============================= -->
	
	<!-- 차트 데이터 가져오기 -->
    <select id="drawChart" resultType="ChartDateDto">
        SELECT
		    COUNT(CASE WHEN login_date = CURDATE() THEN 1 END) AS today,
		    COUNT(CASE WHEN login_date = CURDATE() - INTERVAL 1 DAY THEN 1 END) AS oneDay,
		    COUNT(CASE WHEN login_date = CURDATE() - INTERVAL 2 DAY THEN 1 END) AS twoDay,
		    COUNT(CASE WHEN login_date = CURDATE() - INTERVAL 3 DAY THEN 1 END) AS threeDay,
		    COUNT(CASE WHEN login_date = CURDATE() - INTERVAL 4 DAY THEN 1 END) AS fourDay
		FROM login_log
    </select>
    
    <!-- 신고접수 리스트 가져오기 -->
    <select id="selectListCount" parameterType="String" resultType="_int">
        SELECT COUNT(*)
		FROM member_penalty
		WHERE PN_DATE IS NULL AND PN_TYPE = #{category}
    </select>
    
    <!-- 신고접수 리스트 가져오기 -->
    <select id="selectList" parameterType="String" resultType="MemberPenalty">
        SELECT PN_NO AS pnNo,
        		M.MEM_NO AS memNo,
		        PN_CONTENT AS pnContent,
		        PN_DATE AS pnDate,
		        REP_DATE AS repDate,
		        PN_COUNT AS pnCount,
		        PN_REPORTER AS pnReporter,
		        PN_GROUND AS pnGround,
		        PN_COMMUNITY AS pnCommunity,
		        PN_COMMENT AS pnComment,
		        PN_TYPE AS pnType,
		  		STADIUM_NAME AS stadiumName,
		  		PN_STATUS AS pnStatus
		FROM member_penalty M
		LEFT JOIN STADIUM S ON M.PN_GROUND = S.STADIUM_NO
		WHERE PN_STATUS = 'N' AND PN_TYPE = #{category}
    </select>
    
    <!-- =============================update============================= -->
    
    <!-- 신고 접수하기 -->
    <update id="blockUser" parameterType="_int">
		UPDATE MEMBER m
		JOIN MEMBER_PENALTY mp ON m.MEM_NO = mp.MEM_NO
		SET 
		    mp.PN_COUNT = mp.PN_COUNT + 1,
		    mp.PN_DATE = CASE 
		                    WHEN mp.PN_COUNT + 1 = 3 THEN DATE_ADD(CURDATE(), INTERVAL 7 DAY)
		                    WHEN mp.PN_COUNT + 1 = 6 THEN DATE_ADD(CURDATE(), INTERVAL 1 MONTH)
		                    WHEN mp.PN_COUNT + 1 = 9 THEN DATE_ADD(CURDATE(), INTERVAL 100 YEAR)
		                    ELSE mp.PN_DATE  -- 그 외에는 PN_DATE를 변경하지 않음
		                 END,
		    m.MEM_STATUS = CASE
		                        WHEN mp.PN_COUNT + 1 IN (3, 6, 9) AND m.MEM_STATUS != 'B' THEN 'B'
		                        ELSE m.MEM_STATUS
		                      END
		WHERE m.MEM_NO = #{memNo}
		
		UPDATE MEMBER_PENALTY
		SET
			PN_STATUS = 'Y'
		WHERE PN_NO = #{PN_NO}
		
		UPDATE MEMBER_PENALTY
		SET
			PN_STATUS = 'Y'
		WHERE MEM_NO = #{MEM_NO}
    </update>
</mapper>